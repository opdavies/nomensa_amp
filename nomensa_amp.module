<?php

/**
 * @file
 * Embeds the Nomensa Accessibile Media Player within Drupal.
 */

define('NOMENSA_AMP_SETTINGS_FORM', 'admin/config/media/nomensa-amp');

/**
 * Implements hook_menu().
 */
function nomensa_amp_menu() {
  $items[NOMENSA_AMP_SETTINGS_FORM] = array(
    'title' => 'Nomensa Accessible Media Player',
    'description' => 'Administration functions for the Nomensa Accessible Media Player module',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('nomensa_amp_admin_settings_form'),
    'access arguments' => array('administer nomensa amp'),
    'file' => 'nomensa_amp.admin.inc',
  );

  return $items;
}

/**
 * Implements hook_permission().
 */
function nomensa_amp_permission() {
  return array(
    'administer nomensa amp' => array(
      'title' => t('Administer the Nomensa Accessible Media Player module.'),
    ),
  );
}

/**
 * Implements hook_init().
 *
 * Loads the files from the Nomensa AMP library.
 */
function nomensa_amp_init() {
  if ($settings = variable_get('nomensa_amp_settings')) {
    if ($library_path = libraries_get_path('nomensa_amp')) {
      // Add the jQuery UI slider.
      drupal_add_library('system', 'ui.slider');

      // Add global CSS and javascript files.
      drupal_add_js($library_path . '/core/javascript/swfobject/swfobject.js');
      drupal_add_js($library_path . '/custom/javascript/jquery.loader.js');

      if (isset($settings['advanced']['minimised']) && $settings['advanced']['minimised'] == 1) {
        // Load the minimised files.
        drupal_add_js($library_path . '/core/javascript/jquery.player.min.js');
        drupal_add_css($library_path . '/core/css/player-core.min.css');
        drupal_add_css($library_path . '/custom/css/player-theme.min.css');
      }
      else {
        // Load the normal files.
        drupal_add_js($library_path . '/core/javascript/jquery.player.js');
        drupal_add_css($library_path . '/core/css/player-core.css');
        drupal_add_css($library_path . '/custom/css/player-theme.css');
      }

      foreach ($settings['players'] as $player => $enabled) {
        // Add player-specific files.
        if ($enabled) {
          switch ($player) {
            case 'vimeo':
              drupal_add_js($library_path . '/custom/javascript/config/vimeo/vimeo.config.js');
              break;

            case 'jwplayer':
              drupal_add_js($library_path . '/custom/javascript/config/jwplayer-5/core/jwplayer.js');
              drupal_add_js($library_path . '/custom/javascript/config/jwplayer-5/jw-player.config.js');
              break;
          }
        }
      }

      //pass classname to js
      $class_name = isset($settings['advanced']['classname']) ? $settings['advanced']['classname'] : 'player';
      $my_settings = array(
        'classname' => $class_name,
      );
      drupal_add_js(array('nomensa_amp' => $my_settings), 'setting');
    }
  }
}

/**
 * Implements hook_requirements().
 *
 * Displays an error on the Status Report page is the library doesn't exist.
 */
function nomensa_amp_requirements($phase) {
  $requirements = array();
  $t = get_t();

  if ($phase == 'runtime') {
    $library_path = libraries_get_path('nomensa_amp');
    $requirements['nomensa_amp'] = array(
      'title' => $t('Nomensa Accessible Media Player'),
    );

    if (!is_dir($library_path)) {
      // Library not found.
      $requirements['nomensa_amp']['value'] = $t('Not Found');
      $requirements['nomensa_amp']['severity'] = REQUIREMENT_ERROR;
      $requirements['nomensa_amp']['description'] = $t('The Nomensa AMP library cannot be found. <a href="https://github.com/nomensa/Accessible-Media-Player" title="Nomensa Accessible Media Player">Download it</a> and extract it into <em>sites/all/libraries/nomensa_amp</em>.');
    }
    else {
      if (!$settings = variable_get('nomensa_amp_settings')) {
        // Not configured.
        $requirements['nomensa_amp']['value'] = $t('Not configured');
        $requirements['nomensa_amp']['severity'] = REQUIREMENT_ERROR;
        $requirements['nomensa_amp']['description'] = $t('The module has been enabled, but no video players have been enabled.');
      }
      else {
        // Check to see if any video players have been enabled.
        $configured = in_array('1', $settings['players']);

        if ($configured) {
          // All OK.
          $requirements['nomensa_amp']['value'] = $t('Enabled');
          $requirements['nomensa_amp']['severity'] = REQUIREMENT_OK;
        }
        else {
          // Not configured.
          $requirements['nomensa_amp']['value'] = $t('Not configured');
          $requirements['nomensa_amp']['severity'] = REQUIREMENT_ERROR;
          $requirements['nomensa_amp']['description'] = $t('The module has been enabled, but no video players have been enabled.');
        }
      }
    }
  }

  return $requirements;
}

/**
 * Implement hook_js_alter()
 */
function nomensa_amp_js_alter(&$javascript) {
  if ($library_path = libraries_get_path('nomensa_amp')) {
    $file = drupal_get_path('module', 'nomensa_amp') . '/nomensa_amp.jquery.loader.js';
    $javascript['sites/all/libraries/nomensa_amp/custom/javascript/jquery.loader.js'] = drupal_js_defaults($file);
  }
}
